<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Estado del pago</title>
</head>
<body>
  <h1 id="msg">Procesando tu pago… ⏳</h1>
  <script>
    const params = new URLSearchParams(window.location.search);
    const id =
      params.get('external_reference') ||
      params.get('orderId') ||
      params.get('preference_id') ||
      params.get('pref_id');

    const msg = document.getElementById('msg');

    async function check() {
      try {
        const res = await fetch(`/api/orders/${id}/status`);
        if (!res.ok) return;
        const data = await res.json();
        if (['paid', 'approved'].includes(data.status)) {
          msg.textContent = 'Pago aprobado ✅';
          return true;
        }
        if (data.status === 'rejected') {
          msg.textContent = 'Pago rechazado ❌';
          return true;
        }
        msg.textContent = 'Procesando tu pago… ⏳';
      } catch (e) {
        console.error(e);
      }
      return false;
    }

    let attempts = 0;
    const interval = setInterval(async () => {
      attempts++;
      const done = await check();
      if (done || attempts >= 15) clearInterval(interval);
    }, 4000);
    check();
  </script>
</body>
</html>
